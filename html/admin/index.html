<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Happy Place</title>
</head>
<body>
    <a href="../../">Karte</a>
    <h1>Students</h1>
    <div class="container"></div>
 
    <div class="add_student"></div>
 
    
    <h2>Ort Suchen</h2>
    <div class="searchCity">
        <label for="search">Ort suchen</label>
        <input type="text" name="search" id="search" onkeyup="updateCityList()">
        <div class="cityList"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>


    <script src="../js/config.js"></script>
    <script>

        let toEdit=-1;
        let id_city=-1;


        function updateCityList() {
            search = document.getElementById("search").value;
            const response = fetch(`${baseUrl}/city/?name=${search}`);

            response
                .then(response => response.json())
                .then(json => { 
                    let html = '<table>';
                
                    json.forEach(city => {
                    
                        html += `<tr>
                                <td>${city.plz}</td>
                                <td>${city.city}</td>
                                <td><button onClick="useCity('${city.id}', '${city.plz}', '${city.city}')">übernehmen</button></td>
                            </tr>`;
                    })
              
                    html += "</table>";
                    let container = document.querySelector('.cityList');
                    container.innerHTML = html;                    
                
                });

        }

        function useCity(id, plz, name) {
            id_city=id;
            document.querySelector('.newPlz').innerHTML = plz;
            document.querySelector('.newCity').innerHTML = name;
        }


        function displayAddForm() {
            
            if (toEdit < 0) {
                id_city=-1;
                markerHtml = getMarkerRadioButtons();
                html=`
                    <h2>Schüler hinzufügen</h2>                    
                    <label for="add_name">Name</label>
                    <input type="text" name="name" id="add_name" class="newName">
                    <span>Ort: </span> <span class="newPlz"></span> <span class="newCity">Bitte aus Liste auswählen</span>
                    <span>${markerHtml}</span> 
                    <button onclick="addStudent()">Hinzufügen</button>
                    `;

            } else {
                html = '';
            }
            let container = document.querySelector('.add_student');
            container.innerHTML = html;
        }

        

        function addStudent() {
            let name = document.querySelector('.newName').value;

            let marker = getSaveMarker(document.querySelector('input[name="marker"]:checked').value);

            console.log(marker);

            r = fetch(`${baseUrl}/student/`, { 
                    method: 'POST',
                    body: JSON.stringify({name: name, id_city: id_city, marker: marker})
                } ).then( () => { 
                    loadStudents();            
                    displayAddForm();
                } );
                    
        }

        function cancelUpdateStudent() {
            toEdit=-1;
            displayAddForm();
            loadStudents();
        }

        function updateStudent(id) {
            let name = document.querySelector('.newName').value;
            let marker = getSaveMarker(document.querySelector('input[name="marker"]:checked').value);
            
            r = fetch(`${baseUrl}/student/?id=${id}`, { 
                    method: 'PUT',
                    body: JSON.stringify({name: name, id_city: id_city, marker: marker})
                } ).then( () => { 
                     toEdit=-1; 
                     loadStudents();
                     displayAddForm();
                } );
                   
        }


        function deleteStudent(id) {
            console.log(id); 
            response = fetch(`${baseUrl}/student/?id=${id}`, { method: 'DELETE'} )
                .then(() => {
                    loadStudents();
                    displayAddForm();        
                });
        }


        function editStudent(id) {
            toEdit=id;
            loadStudents();
            displayAddForm();
        }


        function getMarkerRadioButtons(selected) {
            result="";
            index=0;
            selected = getSaveMarker(selected);
            markers.forEach(marker => {
                console.log(selected);
                console.log(index);
                if (index == selected) {
                    checked="checked"
                } else {
                    checked="";
                }
                result = `${result} <input type="radio" name="marker" value="${index}" ${checked}><img src="../../${marker.iconUrl}" alt="Marker"></input>`;

                index++;

            });
            return result;            
        }



        function loadStudents() {
            const response = fetch(`${baseUrl}/student/`)
            response.then(response => response.json() )
                .then(json => { 
                    let html = '<table>';
                
                    json.forEach(student => {
                        hans = student.name;

                        if (student.id == toEdit) {

                            id_city = student.id_city;

                            console.log(student.marker);
                            markerHtml = getMarkerRadioButtons(student.marker);
                            html += `<form action="">
                                    <tr>
                                    <td><input type="text" name="name" class="newName" id="update_name" value="${student.name}""></td>
                                    <td class="newPlz">${student.plz}</td>
                                    <td class="newCity">${student.city}</td>
                                    <td>${markerHtml}</td> 

                                    <td><input type="button" value="Update Student" onclick="updateStudent(`+ student.id + `)"></td>
                                    <td><input type="button" value="Cancel" onclick="cancelUpdateStudent()"></td>
                                    </tr></form>`;

                        } else {

                            marker = markers[getSaveMarker(student.marker)].iconUrl;
                            


                            html += `<tr>
                                    <td>${student.name}</td>
                                    <td>${student.plz}</td>
                                    <td>${student.city}</td>
                                    <td><img src="../../${marker}" alt="Marker"></td>
                                    <td><button onClick="deleteStudent(`+ student.id + `)">remove</button></td>
                                    <td><button onClick="editStudent(`+ student.id + `)">edit</button></td>
                                </tr>`;
                        }
                   
                    });
                    html += "</table>";
                    let container = document.querySelector('.container');
                    container.innerHTML = html;
                })
                .catch(err => console.log('Request Failed', err));
        }

        loadStudents();
        displayAddForm();        
    </script>

</body>
</html>
