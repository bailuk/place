<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <title>Happy Place</title>
    <style>
        #mapid {
            height: 800px;
            width: 800px;
        }
    </style>
</head>

<body>
    <a href="html/admin/">Administrator</a>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    


    <div id="mapid"></div>
    <button onclick="frameStudents()">Frame map</button>

    <script src="html/js/config.js"></script>
    <script>
        let map = L.map('mapid');



        



        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);


        let west = 8.721067;
        let east = 8.733311;
        let north = 47.633246;
        let south = 47.625047;
        frameStudents();


        function frameStudents() {
            map.fitBounds([[south, west], [north, east]]);
        }

        function frameStudent(lat, lon) {
            if (lon < west) {
                west = lon;
            } else if (lon > east) {
                east = lon;
            }

            if (lat > north) {
                north = lat;
            } else  if (lat < south) {
                south = lat;
            }

            frameStudents();
        }


        function addStudent(lat, lon, student) {
            let myIcon = L.icon(markers[getSaveMarker(student.marker)]);
            L.marker([lat, lon], {icon: myIcon}).addTo(map)
                    .bindPopup(student.name)
                    .openPopup();

            frameStudent(lat, lon);    
        }


        function loadCoordinates(student) {
            fetch(`https://nominatim.openstreetmap.org/search?city=${student.city}&postalcode=${student.plz}&format=geojson`)
                .then(response => response.json())
                .then(json => {
                    let lat = json.features[0].geometry.coordinates[1];
                    let lon = json.features[0].geometry.coordinates[0];

                    localStorage.setItem(`${student.id_city}_lat`, lat);
                    localStorage.setItem(`${student.id_city}_lon`, lon);

                    addStudent(lat, lon, student);

                })
                .catch(err => console.log('Request Failed', err));

        }

        function loadStudents() {
            fetch(`${baseUrl}/student/`)
                .then(response => response.json())
                .then(json => {

                    json.forEach(student => {

                        let lat = parseFloat(localStorage.getItem(`${student.id_city}_lat`));
                        let lon = parseFloat(localStorage.getItem(`${student.id_city}_lon`));

                        if (isNaN(lat) || isNaN(lon)) {
                            loadCoordinates(student);

                        } else {
                            addStudent(lat, lon, student);
                        }
                    })
                })
                .catch(err => console.log('Request Failed', err));
        }


        loadStudents();
    </script>

</body>

</html>